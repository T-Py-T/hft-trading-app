apiVersion: v1
kind: ConfigMap
metadata:
  name: load-test-config
data:
  API_URL: "http://hft-backend:8000"
  DURATION_SEC: "60"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: hft-load-test
spec:
  parallelism: 10  # 10 concurrent clients
  completions: 10
  backoffLimit: 3
  template:
    spec:
      containers:
      - name: load-test
        image: python:3.11-slim
        env:
        - name: API_URL
          valueFrom:
            configMapKeyRef:
              name: load-test-config
              key: API_URL
        - name: DURATION_SEC
          valueFrom:
            configMapKeyRef:
              name: load-test-config
              key: DURATION_SEC
        - name: CLIENT_ID
          valueFieldRef:
            fieldPath: metadata.name
        command:
        - sh
        - -c
        - |
          pip install httpx
          cd /scripts
          python distributed_load_test.py
        volumeMounts:
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: scripts
        configMap:
          name: load-test-scripts
          defaultMode: 0755
      restartPolicy: Never
      serviceAccountName: default
